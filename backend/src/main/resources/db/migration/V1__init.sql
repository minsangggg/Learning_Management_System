CREATE TABLE USERS (
  ID NUMBER GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
  EMAIL VARCHAR2(255) NOT NULL UNIQUE,
  PASSWORD_HASH VARCHAR2(255) NOT NULL,
  ROLE VARCHAR2(30) NOT NULL,
  CREATED_AT TIMESTAMP DEFAULT CURRENT_TIMESTAMP NOT NULL
);

CREATE TABLE COURSES (
  ID NUMBER GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
  TITLE VARCHAR2(200) NOT NULL,
  DESCRIPTION VARCHAR2(1000),
  CREATED_AT TIMESTAMP DEFAULT CURRENT_TIMESTAMP NOT NULL
);

CREATE TABLE LESSONS (
  ID NUMBER GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
  COURSE_ID NUMBER NOT NULL,
  TITLE VARCHAR2(200) NOT NULL,
  CONTENT VARCHAR2(2000),
  ORDER_NO NUMBER(6) NOT NULL,
  CONSTRAINT FK_LESSONS_COURSE FOREIGN KEY (COURSE_ID) REFERENCES COURSES(ID)
);

CREATE TABLE ENROLLMENTS (
  ID NUMBER GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
  USER_ID NUMBER NOT NULL,
  COURSE_ID NUMBER NOT NULL,
  STATUS VARCHAR2(30) NOT NULL,
  ENROLLED_AT TIMESTAMP DEFAULT CURRENT_TIMESTAMP NOT NULL,
  CONSTRAINT FK_ENROLLMENTS_USER FOREIGN KEY (USER_ID) REFERENCES USERS(ID),
  CONSTRAINT FK_ENROLLMENTS_COURSE FOREIGN KEY (COURSE_ID) REFERENCES COURSES(ID)
);

CREATE TABLE PROGRESS (
  ID NUMBER GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
  ENROLLMENT_ID NUMBER NOT NULL,
  LESSON_ID NUMBER NOT NULL,
  PROGRESS_PERCENT NUMBER(5,2) DEFAULT 0 NOT NULL,
  COMPLETED_AT TIMESTAMP,
  CONSTRAINT FK_PROGRESS_ENROLLMENT FOREIGN KEY (ENROLLMENT_ID) REFERENCES ENROLLMENTS(ID),
  CONSTRAINT FK_PROGRESS_LESSON FOREIGN KEY (LESSON_ID) REFERENCES LESSONS(ID)
);

CREATE TABLE AI_REQUESTS (
  ID NUMBER GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
  USER_ID NUMBER,
  MODEL_NAME VARCHAR2(50) NOT NULL,
  REQUEST_TEXT CLOB NOT NULL,
  RESPONSE_TEXT CLOB,
  LATENCY_MS NUMBER(10),
  STATUS VARCHAR2(30) NOT NULL,
  CREATED_AT TIMESTAMP DEFAULT CURRENT_TIMESTAMP NOT NULL,
  CONSTRAINT FK_AI_REQUESTS_USER FOREIGN KEY (USER_ID) REFERENCES USERS(ID)
);

CREATE INDEX IDX_USERS_ROLE ON USERS (ROLE);
CREATE INDEX IDX_COURSES_CREATED_AT ON COURSES (CREATED_AT);
CREATE INDEX IDX_LESSONS_COURSE_ID ON LESSONS (COURSE_ID);
CREATE INDEX IDX_LESSONS_ORDER ON LESSONS (COURSE_ID, ORDER_NO);
CREATE INDEX IDX_ENROLLMENTS_USER ON ENROLLMENTS (USER_ID);
CREATE INDEX IDX_ENROLLMENTS_COURSE ON ENROLLMENTS (COURSE_ID);
CREATE INDEX IDX_ENROLLMENTS_STATUS ON ENROLLMENTS (STATUS);
CREATE INDEX IDX_ENROLLMENTS_ENROLLED_AT ON ENROLLMENTS (ENROLLED_AT);
CREATE INDEX IDX_PROGRESS_ENROLLMENT ON PROGRESS (ENROLLMENT_ID);
CREATE INDEX IDX_PROGRESS_LESSON ON PROGRESS (LESSON_ID);
CREATE INDEX IDX_PROGRESS_COMPLETED_AT ON PROGRESS (COMPLETED_AT);
CREATE INDEX IDX_AI_REQUESTS_USER ON AI_REQUESTS (USER_ID);
CREATE INDEX IDX_AI_REQUESTS_MODEL ON AI_REQUESTS (MODEL_NAME);
CREATE INDEX IDX_AI_REQUESTS_STATUS ON AI_REQUESTS (STATUS);
CREATE INDEX IDX_AI_REQUESTS_CREATED_AT ON AI_REQUESTS (CREATED_AT);
