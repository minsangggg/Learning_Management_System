BEGIN
  EXECUTE IMMEDIATE '
    CREATE TABLE LEARNING_GUIDES (
      ID NUMBER GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
      USER_ID NUMBER NOT NULL,
      COURSE_ID NUMBER NOT NULL,
      GUIDE_TEXT CLOB NOT NULL,
      CREATED_AT TIMESTAMP DEFAULT CURRENT_TIMESTAMP NOT NULL,
      CONSTRAINT FK_GUIDES_USER FOREIGN KEY (USER_ID) REFERENCES USERS(ID),
      CONSTRAINT FK_GUIDES_COURSE FOREIGN KEY (COURSE_ID) REFERENCES COURSES(ID)
    )';
EXCEPTION
  WHEN OTHERS THEN
    IF SQLCODE != -955 THEN
      RAISE;
    END IF;
END;
/

BEGIN
  EXECUTE IMMEDIATE 'CREATE INDEX IDX_GUIDES_USER ON LEARNING_GUIDES (USER_ID)';
EXCEPTION
  WHEN OTHERS THEN
    IF SQLCODE != -955 THEN
      RAISE;
    END IF;
END;
/

BEGIN
  EXECUTE IMMEDIATE 'CREATE INDEX IDX_GUIDES_COURSE ON LEARNING_GUIDES (COURSE_ID)';
EXCEPTION
  WHEN OTHERS THEN
    IF SQLCODE != -955 THEN
      RAISE;
    END IF;
END;
/

DELETE FROM PROGRESS
WHERE ENROLLMENT_ID IN (
  SELECT e.ID
  FROM ENROLLMENTS e
  JOIN COURSES c ON c.ID = e.COURSE_ID
  WHERE c.TITLE IN (
    'Practical Java Fundamentals',
    'Spring Boot API Essentials',
    'Database Modeling with Oracle',
    'Frontend Basics for LMS'
  )
);

DELETE FROM ENROLLMENTS
WHERE COURSE_ID IN (
  SELECT ID
  FROM COURSES
  WHERE TITLE IN (
    'Practical Java Fundamentals',
    'Spring Boot API Essentials',
    'Database Modeling with Oracle',
    'Frontend Basics for LMS'
  )
);

DELETE FROM LESSONS
WHERE COURSE_ID IN (
  SELECT ID
  FROM COURSES
  WHERE TITLE IN (
    'Practical Java Fundamentals',
    'Spring Boot API Essentials',
    'Database Modeling with Oracle',
    'Frontend Basics for LMS'
  )
);

DELETE FROM COURSES
WHERE TITLE IN (
  'Practical Java Fundamentals',
  'Spring Boot API Essentials',
  'Database Modeling with Oracle',
  'Frontend Basics for LMS'
);

MERGE INTO COURSES c
USING (
  SELECT
    'AI시대 창의력 훈련법' AS TITLE,
    'AI 시대에 필요한 창의력 사고와 프롬프트 연습을 다룹니다.' AS DESCRIPTION
  FROM dual
) src
ON (c.TITLE = src.TITLE)
WHEN NOT MATCHED THEN
  INSERT (TITLE, DESCRIPTION) VALUES (src.TITLE, src.DESCRIPTION);

MERGE INTO COURSES c
USING (
  SELECT
    '창의력을 높이는 테크닉' AS TITLE,
    '발상법과 아이디어 확장 테크닉을 단계별로 학습합니다.' AS DESCRIPTION
  FROM dual
) src
ON (c.TITLE = src.TITLE)
WHEN NOT MATCHED THEN
  INSERT (TITLE, DESCRIPTION) VALUES (src.TITLE, src.DESCRIPTION);

MERGE INTO COURSES c
USING (
  SELECT
    '데이터 분석의 힘' AS TITLE,
    '데이터 해석부터 의사결정까지 분석 흐름을 익힙니다.' AS DESCRIPTION
  FROM dual
) src
ON (c.TITLE = src.TITLE)
WHEN NOT MATCHED THEN
  INSERT (TITLE, DESCRIPTION) VALUES (src.TITLE, src.DESCRIPTION);

MERGE INTO LESSONS l
USING (
  SELECT c.ID AS COURSE_ID, 1 AS ORDER_NO, '창의력과 AI의 만남' AS TITLE, 'AI 시대의 창의력 개요를 이해합니다.' AS CONTENT
  FROM COURSES c WHERE c.TITLE = 'AI시대 창의력 훈련법'
) src
ON (l.COURSE_ID = src.COURSE_ID AND l.ORDER_NO = src.ORDER_NO)
WHEN NOT MATCHED THEN INSERT (COURSE_ID, TITLE, CONTENT, ORDER_NO)
VALUES (src.COURSE_ID, src.TITLE, src.CONTENT, src.ORDER_NO);

MERGE INTO LESSONS l
USING (
  SELECT c.ID AS COURSE_ID, 2 AS ORDER_NO, '문제 재정의 연습' AS TITLE, '문제를 다시 정의하는 사고법을 다룹니다.' AS CONTENT
  FROM COURSES c WHERE c.TITLE = 'AI시대 창의력 훈련법'
) src
ON (l.COURSE_ID = src.COURSE_ID AND l.ORDER_NO = src.ORDER_NO)
WHEN NOT MATCHED THEN INSERT (COURSE_ID, TITLE, CONTENT, ORDER_NO)
VALUES (src.COURSE_ID, src.TITLE, src.CONTENT, src.ORDER_NO);

MERGE INTO LESSONS l
USING (
  SELECT c.ID AS COURSE_ID, 3 AS ORDER_NO, '아이디어 발산 기법' AS TITLE, '아이디어를 풍부하게 만드는 방법을 익힙니다.' AS CONTENT
  FROM COURSES c WHERE c.TITLE = 'AI시대 창의력 훈련법'
) src
ON (l.COURSE_ID = src.COURSE_ID AND l.ORDER_NO = src.ORDER_NO)
WHEN NOT MATCHED THEN INSERT (COURSE_ID, TITLE, CONTENT, ORDER_NO)
VALUES (src.COURSE_ID, src.TITLE, src.CONTENT, src.ORDER_NO);

MERGE INTO LESSONS l
USING (
  SELECT c.ID AS COURSE_ID, 4 AS ORDER_NO, 'AI 협업 프롬프트' AS TITLE, 'AI와 함께 생각하는 프롬프트 설계를 연습합니다.' AS CONTENT
  FROM COURSES c WHERE c.TITLE = 'AI시대 창의력 훈련법'
) src
ON (l.COURSE_ID = src.COURSE_ID AND l.ORDER_NO = src.ORDER_NO)
WHEN NOT MATCHED THEN INSERT (COURSE_ID, TITLE, CONTENT, ORDER_NO)
VALUES (src.COURSE_ID, src.TITLE, src.CONTENT, src.ORDER_NO);

MERGE INTO LESSONS l
USING (
  SELECT c.ID AS COURSE_ID, 5 AS ORDER_NO, '발상 스케치' AS TITLE, '아이디어를 시각화하는 스케치를 진행합니다.' AS CONTENT
  FROM COURSES c WHERE c.TITLE = 'AI시대 창의력 훈련법'
) src
ON (l.COURSE_ID = src.COURSE_ID AND l.ORDER_NO = src.ORDER_NO)
WHEN NOT MATCHED THEN INSERT (COURSE_ID, TITLE, CONTENT, ORDER_NO)
VALUES (src.COURSE_ID, src.TITLE, src.CONTENT, src.ORDER_NO);

MERGE INTO LESSONS l
USING (
  SELECT c.ID AS COURSE_ID, 6 AS ORDER_NO, '피드백 루프' AS TITLE, '피드백으로 아이디어를 개선합니다.' AS CONTENT
  FROM COURSES c WHERE c.TITLE = 'AI시대 창의력 훈련법'
) src
ON (l.COURSE_ID = src.COURSE_ID AND l.ORDER_NO = src.ORDER_NO)
WHEN NOT MATCHED THEN INSERT (COURSE_ID, TITLE, CONTENT, ORDER_NO)
VALUES (src.COURSE_ID, src.TITLE, src.CONTENT, src.ORDER_NO);

MERGE INTO LESSONS l
USING (
  SELECT c.ID AS COURSE_ID, 7 AS ORDER_NO, '미니 프로젝트' AS TITLE, '실전 과제를 통해 학습 내용을 정리합니다.' AS CONTENT
  FROM COURSES c WHERE c.TITLE = 'AI시대 창의력 훈련법'
) src
ON (l.COURSE_ID = src.COURSE_ID AND l.ORDER_NO = src.ORDER_NO)
WHEN NOT MATCHED THEN INSERT (COURSE_ID, TITLE, CONTENT, ORDER_NO)
VALUES (src.COURSE_ID, src.TITLE, src.CONTENT, src.ORDER_NO);

MERGE INTO LESSONS l
USING (
  SELECT c.ID AS COURSE_ID, 1 AS ORDER_NO, '창의력 이론 정리' AS TITLE, '창의력 개념과 핵심 원리를 정리합니다.' AS CONTENT
  FROM COURSES c WHERE c.TITLE = '창의력을 높이는 테크닉'
) src
ON (l.COURSE_ID = src.COURSE_ID AND l.ORDER_NO = src.ORDER_NO)
WHEN NOT MATCHED THEN INSERT (COURSE_ID, TITLE, CONTENT, ORDER_NO)
VALUES (src.COURSE_ID, src.TITLE, src.CONTENT, src.ORDER_NO);

MERGE INTO LESSONS l
USING (
  SELECT c.ID AS COURSE_ID, 2 AS ORDER_NO, 'SCAMPER 실습' AS TITLE, 'SCAMPER 기법을 실제 사례로 연습합니다.' AS CONTENT
  FROM COURSES c WHERE c.TITLE = '창의력을 높이는 테크닉'
) src
ON (l.COURSE_ID = src.COURSE_ID AND l.ORDER_NO = src.ORDER_NO)
WHEN NOT MATCHED THEN INSERT (COURSE_ID, TITLE, CONTENT, ORDER_NO)
VALUES (src.COURSE_ID, src.TITLE, src.CONTENT, src.ORDER_NO);

MERGE INTO LESSONS l
USING (
  SELECT c.ID AS COURSE_ID, 3 AS ORDER_NO, '브레인스토밍 그리드' AS TITLE, '아이디어 흐름을 구조화하는 방법을 익힙니다.' AS CONTENT
  FROM COURSES c WHERE c.TITLE = '창의력을 높이는 테크닉'
) src
ON (l.COURSE_ID = src.COURSE_ID AND l.ORDER_NO = src.ORDER_NO)
WHEN NOT MATCHED THEN INSERT (COURSE_ID, TITLE, CONTENT, ORDER_NO)
VALUES (src.COURSE_ID, src.TITLE, src.CONTENT, src.ORDER_NO);

MERGE INTO LESSONS l
USING (
  SELECT c.ID AS COURSE_ID, 4 AS ORDER_NO, '관점 전환 카드' AS TITLE, '관점을 바꾸어 문제를 재해석합니다.' AS CONTENT
  FROM COURSES c WHERE c.TITLE = '창의력을 높이는 테크닉'
) src
ON (l.COURSE_ID = src.COURSE_ID AND l.ORDER_NO = src.ORDER_NO)
WHEN NOT MATCHED THEN INSERT (COURSE_ID, TITLE, CONTENT, ORDER_NO)
VALUES (src.COURSE_ID, src.TITLE, src.CONTENT, src.ORDER_NO);

MERGE INTO LESSONS l
USING (
  SELECT c.ID AS COURSE_ID, 5 AS ORDER_NO, '스토리보드' AS TITLE, '아이디어를 이야기로 구성합니다.' AS CONTENT
  FROM COURSES c WHERE c.TITLE = '창의력을 높이는 테크닉'
) src
ON (l.COURSE_ID = src.COURSE_ID AND l.ORDER_NO = src.ORDER_NO)
WHEN NOT MATCHED THEN INSERT (COURSE_ID, TITLE, CONTENT, ORDER_NO)
VALUES (src.COURSE_ID, src.TITLE, src.CONTENT, src.ORDER_NO);

MERGE INTO LESSONS l
USING (
  SELECT c.ID AS COURSE_ID, 6 AS ORDER_NO, '프로토타이핑' AS TITLE, '빠르게 실험하고 개선합니다.' AS CONTENT
  FROM COURSES c WHERE c.TITLE = '창의력을 높이는 테크닉'
) src
ON (l.COURSE_ID = src.COURSE_ID AND l.ORDER_NO = src.ORDER_NO)
WHEN NOT MATCHED THEN INSERT (COURSE_ID, TITLE, CONTENT, ORDER_NO)
VALUES (src.COURSE_ID, src.TITLE, src.CONTENT, src.ORDER_NO);

MERGE INTO LESSONS l
USING (
  SELECT c.ID AS COURSE_ID, 7 AS ORDER_NO, '아이디어 검증' AS TITLE, '아이디어 검증과 개선 루프를 정리합니다.' AS CONTENT
  FROM COURSES c WHERE c.TITLE = '창의력을 높이는 테크닉'
) src
ON (l.COURSE_ID = src.COURSE_ID AND l.ORDER_NO = src.ORDER_NO)
WHEN NOT MATCHED THEN INSERT (COURSE_ID, TITLE, CONTENT, ORDER_NO)
VALUES (src.COURSE_ID, src.TITLE, src.CONTENT, src.ORDER_NO);

MERGE INTO LESSONS l
USING (
  SELECT c.ID AS COURSE_ID, 1 AS ORDER_NO, '데이터 분석 기본기' AS TITLE, '데이터 분석의 기본 흐름을 이해합니다.' AS CONTENT
  FROM COURSES c WHERE c.TITLE = '데이터 분석의 힘'
) src
ON (l.COURSE_ID = src.COURSE_ID AND l.ORDER_NO = src.ORDER_NO)
WHEN NOT MATCHED THEN INSERT (COURSE_ID, TITLE, CONTENT, ORDER_NO)
VALUES (src.COURSE_ID, src.TITLE, src.CONTENT, src.ORDER_NO);

MERGE INTO LESSONS l
USING (
  SELECT c.ID AS COURSE_ID, 2 AS ORDER_NO, '지표 설계' AS TITLE, '핵심 지표를 정의하고 설계합니다.' AS CONTENT
  FROM COURSES c WHERE c.TITLE = '데이터 분석의 힘'
) src
ON (l.COURSE_ID = src.COURSE_ID AND l.ORDER_NO = src.ORDER_NO)
WHEN NOT MATCHED THEN INSERT (COURSE_ID, TITLE, CONTENT, ORDER_NO)
VALUES (src.COURSE_ID, src.TITLE, src.CONTENT, src.ORDER_NO);

MERGE INTO LESSONS l
USING (
  SELECT c.ID AS COURSE_ID, 3 AS ORDER_NO, 'SQL로 데이터 읽기' AS TITLE, '기본 SQL로 데이터를 조회합니다.' AS CONTENT
  FROM COURSES c WHERE c.TITLE = '데이터 분석의 힘'
) src
ON (l.COURSE_ID = src.COURSE_ID AND l.ORDER_NO = src.ORDER_NO)
WHEN NOT MATCHED THEN INSERT (COURSE_ID, TITLE, CONTENT, ORDER_NO)
VALUES (src.COURSE_ID, src.TITLE, src.CONTENT, src.ORDER_NO);

MERGE INTO LESSONS l
USING (
  SELECT c.ID AS COURSE_ID, 4 AS ORDER_NO, '시각화 기초' AS TITLE, '차트로 인사이트를 확인합니다.' AS CONTENT
  FROM COURSES c WHERE c.TITLE = '데이터 분석의 힘'
) src
ON (l.COURSE_ID = src.COURSE_ID AND l.ORDER_NO = src.ORDER_NO)
WHEN NOT MATCHED THEN INSERT (COURSE_ID, TITLE, CONTENT, ORDER_NO)
VALUES (src.COURSE_ID, src.TITLE, src.CONTENT, src.ORDER_NO);

MERGE INTO LESSONS l
USING (
  SELECT c.ID AS COURSE_ID, 5 AS ORDER_NO, '인사이트 도출' AS TITLE, '의미 있는 패턴을 도출합니다.' AS CONTENT
  FROM COURSES c WHERE c.TITLE = '데이터 분석의 힘'
) src
ON (l.COURSE_ID = src.COURSE_ID AND l.ORDER_NO = src.ORDER_NO)
WHEN NOT MATCHED THEN INSERT (COURSE_ID, TITLE, CONTENT, ORDER_NO)
VALUES (src.COURSE_ID, src.TITLE, src.CONTENT, src.ORDER_NO);

MERGE INTO LESSONS l
USING (
  SELECT c.ID AS COURSE_ID, 6 AS ORDER_NO, '의사결정 적용' AS TITLE, '분석 결과를 의사결정에 적용합니다.' AS CONTENT
  FROM COURSES c WHERE c.TITLE = '데이터 분석의 힘'
) src
ON (l.COURSE_ID = src.COURSE_ID AND l.ORDER_NO = src.ORDER_NO)
WHEN NOT MATCHED THEN INSERT (COURSE_ID, TITLE, CONTENT, ORDER_NO)
VALUES (src.COURSE_ID, src.TITLE, src.CONTENT, src.ORDER_NO);

MERGE INTO LESSONS l
USING (
  SELECT c.ID AS COURSE_ID, 7 AS ORDER_NO, '리포트 작성' AS TITLE, '분석 리포트를 작성하고 공유합니다.' AS CONTENT
  FROM COURSES c WHERE c.TITLE = '데이터 분석의 힘'
) src
ON (l.COURSE_ID = src.COURSE_ID AND l.ORDER_NO = src.ORDER_NO)
WHEN NOT MATCHED THEN INSERT (COURSE_ID, TITLE, CONTENT, ORDER_NO)
VALUES (src.COURSE_ID, src.TITLE, src.CONTENT, src.ORDER_NO);

MERGE INTO USERS u
USING (
  SELECT 'learner01@lms.demo' AS EMAIL, '김이박' AS NAME, '데모기관 A' AS COMPANY FROM dual UNION ALL
  SELECT 'learner02@lms.demo', '이민수', '데모기관 B' FROM dual UNION ALL
  SELECT 'learner03@lms.demo', '박서연', '데모기관 C' FROM dual UNION ALL
  SELECT 'learner04@lms.demo', '최준호', '데모기관 D' FROM dual UNION ALL
  SELECT 'learner05@lms.demo', '정유진', '데모기관 E' FROM dual UNION ALL
  SELECT 'learner06@lms.demo', '강도윤', '데모기관 F' FROM dual UNION ALL
  SELECT 'learner07@lms.demo', '조하늘', '데모기관 G' FROM dual UNION ALL
  SELECT 'learner08@lms.demo', '오서준', '데모기관 H' FROM dual UNION ALL
  SELECT 'learner09@lms.demo', '윤아름', '데모기관 I' FROM dual UNION ALL
  SELECT 'learner10@lms.demo', '한지수', '데모기관 J' FROM dual UNION ALL
  SELECT 'learner11@lms.demo', '신서윤', '데모기관 K' FROM dual UNION ALL
  SELECT 'learner12@lms.demo', '배준서', '데모기관 L' FROM dual UNION ALL
  SELECT 'learner13@lms.demo', '노현우', '데모기관 M' FROM dual UNION ALL
  SELECT 'learner14@lms.demo', '홍지민', '데모기관 N' FROM dual UNION ALL
  SELECT 'learner15@lms.demo', '문동혁', '데모기관 O' FROM dual UNION ALL
  SELECT 'learner16@lms.demo', '유하린', '데모기관 P' FROM dual UNION ALL
  SELECT 'learner17@lms.demo', '방수빈', '데모기관 Q' FROM dual UNION ALL
  SELECT 'learner18@lms.demo', '권태윤', '데모기관 R' FROM dual UNION ALL
  SELECT 'learner19@lms.demo', '고예림', '데모기관 S' FROM dual UNION ALL
  SELECT 'learner20@lms.demo', '황도현', '데모기관 T' FROM dual
) src
ON (u.EMAIL = src.EMAIL)
WHEN NOT MATCHED THEN
  INSERT (EMAIL, PASSWORD_HASH, ROLE, NAME, COMPANY)
  VALUES (src.EMAIL, '$2a$10$Fvqjr4AEIXn.XJVJ6DNKiO/MufYaTFZsC9mEsB3bzm.8tpddTwV/O', 'LEARNER', src.NAME, src.COMPANY);

INSERT INTO ENROLLMENTS (USER_ID, COURSE_ID, STATUS)
SELECT u.ID, c.ID, 'ACTIVE'
FROM (
  SELECT ID, EMAIL, TO_NUMBER(SUBSTR(EMAIL, 8, 2)) AS IDX
  FROM USERS
  WHERE EMAIL LIKE 'learner%lms.demo'
) u
JOIN COURSES c ON c.TITLE = 'AI시대 창의력 훈련법'
WHERE u.IDX BETWEEN 1 AND 10
AND NOT EXISTS (
  SELECT 1 FROM ENROLLMENTS e WHERE e.USER_ID = u.ID AND e.COURSE_ID = c.ID
);

INSERT INTO ENROLLMENTS (USER_ID, COURSE_ID, STATUS)
SELECT u.ID, c.ID, 'ACTIVE'
FROM (
  SELECT ID, EMAIL, TO_NUMBER(SUBSTR(EMAIL, 8, 2)) AS IDX
  FROM USERS
  WHERE EMAIL LIKE 'learner%lms.demo'
) u
JOIN COURSES c ON c.TITLE = '창의력을 높이는 테크닉'
WHERE u.IDX BETWEEN 6 AND 15
AND NOT EXISTS (
  SELECT 1 FROM ENROLLMENTS e WHERE e.USER_ID = u.ID AND e.COURSE_ID = c.ID
);

INSERT INTO ENROLLMENTS (USER_ID, COURSE_ID, STATUS)
SELECT u.ID, c.ID, 'ACTIVE'
FROM (
  SELECT ID, EMAIL, TO_NUMBER(SUBSTR(EMAIL, 8, 2)) AS IDX
  FROM USERS
  WHERE EMAIL LIKE 'learner%lms.demo'
) u
JOIN COURSES c ON c.TITLE = '데이터 분석의 힘'
WHERE u.IDX BETWEEN 11 AND 20
AND NOT EXISTS (
  SELECT 1 FROM ENROLLMENTS e WHERE e.USER_ID = u.ID AND e.COURSE_ID = c.ID
);

INSERT INTO PROGRESS (ENROLLMENT_ID, LESSON_ID, PROGRESS_PERCENT, COMPLETED_AT)
SELECT
  e.ID,
  l.ID,
  CASE
    WHEN MOD(u.IDX, 3) = 0 THEN CASE WHEN l.ORDER_NO <= 5 THEN 100 WHEN l.ORDER_NO <= 6 THEN 60 ELSE 30 END
    WHEN MOD(u.IDX, 3) = 1 THEN CASE WHEN l.ORDER_NO <= 3 THEN 100 WHEN l.ORDER_NO <= 5 THEN 50 ELSE 10 END
    ELSE CASE WHEN l.ORDER_NO <= 2 THEN 100 WHEN l.ORDER_NO <= 4 THEN 40 ELSE 0 END
  END AS PROGRESS_PERCENT,
  CASE
    WHEN MOD(u.IDX, 3) = 0 AND l.ORDER_NO <= 5 THEN CURRENT_TIMESTAMP
    WHEN MOD(u.IDX, 3) = 1 AND l.ORDER_NO <= 3 THEN CURRENT_TIMESTAMP
    WHEN MOD(u.IDX, 3) = 2 AND l.ORDER_NO <= 2 THEN CURRENT_TIMESTAMP
    ELSE NULL
  END AS COMPLETED_AT
FROM ENROLLMENTS e
JOIN (
  SELECT ID, EMAIL, TO_NUMBER(SUBSTR(EMAIL, 8, 2)) AS IDX
  FROM USERS
  WHERE EMAIL LIKE 'learner%lms.demo'
) u ON u.ID = e.USER_ID
JOIN LESSONS l ON l.COURSE_ID = e.COURSE_ID
WHERE NOT EXISTS (
  SELECT 1 FROM PROGRESS p WHERE p.ENROLLMENT_ID = e.ID AND p.LESSON_ID = l.ID
);

INSERT INTO LEARNING_GUIDES (USER_ID, COURSE_ID, GUIDE_TEXT)
SELECT
  e.USER_ID,
  e.COURSE_ID,
  CASE MOD(u.IDX, 3)
    WHEN 0 THEN '주 3회 30분 학습 후 과제 1개 수행. 복습 체크리스트를 작성하세요.'
    WHEN 1 THEN '주 2회 45분 집중 학습. 학습 요약을 3줄로 기록하세요.'
    ELSE '주 5회 20분 학습. 문제 해결을 카드로 정리하세요.'
  END || ' 목표: ' || c.TITLE || ' 완주'
FROM ENROLLMENTS e
JOIN (
  SELECT ID, EMAIL, TO_NUMBER(SUBSTR(EMAIL, 8, 2)) AS IDX
  FROM USERS
  WHERE EMAIL LIKE 'learner%lms.demo'
) u ON u.ID = e.USER_ID
JOIN COURSES c ON c.ID = e.COURSE_ID
WHERE NOT EXISTS (
  SELECT 1 FROM LEARNING_GUIDES g WHERE g.USER_ID = e.USER_ID AND g.COURSE_ID = e.COURSE_ID
);

INSERT INTO AI_REQUESTS (
  USER_ID, MODEL_NAME, REQUEST_TEXT, RESPONSE_TEXT, LATENCY_MS, STATUS, CREATED_AT
)
SELECT
  u.ID,
  'gpt-4o-mini',
  '요약 요청: ' || c.TITLE || ' - 핵심 내용을 5줄로 요약해줘.',
  CASE MOD(u.IDX, 3)
    WHEN 0 THEN '요약: 핵심 개념, 실습 포인트, 적용 방법, 체크리스트, 다음 단계.'
    WHEN 1 THEN '요약: 개념 정리, 사례 이해, 실습 과제, 리뷰 포인트, 확장 학습.'
    ELSE '요약: 문제 정의, 아이디어 발상, 검증 방법, 개선 루프, 정리.'
  END,
  160 + MOD(u.IDX, 40),
  'SUCCESS',
  CURRENT_TIMESTAMP - NUMTODSINTERVAL(MOD(u.IDX, 7), 'DAY')
FROM (
  SELECT ID, EMAIL, TO_NUMBER(SUBSTR(EMAIL, 8, 2)) AS IDX
  FROM USERS
  WHERE EMAIL LIKE 'learner%lms.demo'
) u
JOIN COURSES c ON c.TITLE = CASE
  WHEN u.IDX BETWEEN 1 AND 10 THEN 'AI시대 창의력 훈련법'
  WHEN u.IDX BETWEEN 11 AND 15 THEN '창의력을 높이는 테크닉'
  ELSE '데이터 분석의 힘'
END
WHERE NOT EXISTS (
  SELECT 1 FROM AI_REQUESTS a
  WHERE a.USER_ID = u.ID AND a.MODEL_NAME = 'gpt-4o-mini'
    AND a.REQUEST_TEXT LIKE '요약 요청:%'
);

INSERT INTO AI_REQUESTS (
  USER_ID, MODEL_NAME, REQUEST_TEXT, RESPONSE_TEXT, LATENCY_MS, STATUS, CREATED_AT
)
SELECT
  u.ID,
  'gpt-4o-mini',
  '퀴즈 생성: ' || c.TITLE || ' - 객관식 3문항을 만들어줘.',
  'Q1... A1. Q2... A2. Q3... A3.',
  200 + MOD(u.IDX, 35),
  'SUCCESS',
  CURRENT_TIMESTAMP - NUMTODSINTERVAL(MOD(u.IDX, 5), 'DAY')
FROM (
  SELECT ID, EMAIL, TO_NUMBER(SUBSTR(EMAIL, 8, 2)) AS IDX
  FROM USERS
  WHERE EMAIL LIKE 'learner%lms.demo'
) u
JOIN COURSES c ON c.TITLE = CASE
  WHEN u.IDX BETWEEN 1 AND 10 THEN 'AI시대 창의력 훈련법'
  WHEN u.IDX BETWEEN 11 AND 15 THEN '창의력을 높이는 테크닉'
  ELSE '데이터 분석의 힘'
END
WHERE NOT EXISTS (
  SELECT 1 FROM AI_REQUESTS a
  WHERE a.USER_ID = u.ID AND a.MODEL_NAME = 'gpt-4o-mini'
    AND a.REQUEST_TEXT LIKE '퀴즈 생성:%'
);
